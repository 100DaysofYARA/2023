rule file_cve_2022_46689
{
  meta:
    description = "Identify macOS binaries exploiting CVE-2022-46689 (MacDirtyCoW)."
    author = "@shellcromancer"
    version = "1.0"
    date = "2023.04.05"
    reference = "https://github.com/zhuowei/MacDirtyCowDemo/"
    sample = "2a3cf68a766440bee6cf58f4ad5d390adc8d01f746ac838dc132968d846faf49"
    DaysofYARA = "95/100"

  strings:
    $api0 = "dispatch_semaphore_create"
    $api1 = "pthread_mutex_init"
    $api2 = "wrong mem_entry size"
    $api3 = "vm_read_overwrite"
    $api4 = "vm_deallocate"
    $api5 = "pthread_create"
    $api6 = "pthread_mutex_lock"
    $api7 = "pthread_mutex_unlock"

    $log0 = "Testing for %ld seconds..."
    $log1 = "Ran %d times in %ld seconds with no failure"
    $log2 = "RO mapping was modified"
    $log3 = "no diff?"
    $log4 = "too long!"

  condition:
    (
    uint32(0) == 0xfeedface or  // Mach-O MH_MAGIC
    uint32(0) == 0xcefaedfe or  // Mach-O MH_CIGAM
    uint32(0) == 0xfeedfacf or  // Mach-O MH_MAGIC_64
    uint32(0) == 0xcffaedfe or  // Mach-O MH_CIGAM_64
    uint32(0) == 0xcafebabe or  // Mach-O FAT_MAGIC
    uint32(0) == 0xbebafeca  // Mach-O FAT_CIGAM
    ) and (
    3 of ($log*) or
    all of ($api*)
    )
}
